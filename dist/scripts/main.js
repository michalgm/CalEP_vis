var districts=[],matrix=[],districtIndex={},rows=[],svg,info,width=750,height=750,innerRadius=.41*Math.min(width,height),outerRadius=1.1*innerRadius,addDistrict=function(t){t&&(districtIndex[t]||(districtIndex[t]=1))},createMap=function(t){var i=$("input:radio[name=display-type]:checked").val();rows=t,$.each(t,function(t,i){addDistrict(i.give),addDistrict(i.get);for(var e=2;i["get_"+e];)addDistrict(i["get_"+e]),e++});var e=0;$.each(districtIndex,function(t){for(districtIndex[t]=e,matrix[e]=[],c=0;c<Object.keys(districtIndex).length;c++)matrix[e].push(0);districts[e]={index:e,name:t,relationships:[]},e++});var r=function(t,e,r,n){"give"==i?e=districtIndex[n]:t=districtIndex[n],matrix[t][e]++,"both"==i&&matrix[e][t]++,void 0===districts[t].relationships[e]?districts[t].relationships[e]=[r]:districts[t].relationships[e].push(r)};$.each(t,function(t,e){if(e.give){var n,a;"give"==i?n=districtIndex[e.give]:a=districtIndex[e.give],e.get&&r(n,a,t,e.get);for(var d=2;e["get_"+d];)r(n,a,t,e["get_"+d]),d++}}),console.log(JSON.stringify(matrix).replace(/],/g,"],\n")),drawGraph()},initGraph=function(){svg=d3.select("body").append("svg").attr("id","chordGraph").attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height/2+")"),info=d3.select("body").append("div").attr("id","info"),$("#display-controls input").on("change",redrawGraph)},redrawGraph=function(){matrix=[],districtIndex={},districts=[],svg.selectAll("*").remove(),createMap(rows)},drawGraph=function(){var t=function(t){return function(i,e){svg.selectAll(".chord path").filter(function(t){return t.source.index!==e&&t.target.index!==e}).transition().style("opacity",t)}},i=d3.layout.chord().padding(.02).sortSubgroups(d3.descending).matrix(matrix),e=d3.scale.category20();svg.append("g").selectAll("path").data(i.groups).enter().append("path").style("fill",function(t){return e(t.index)}).style("stroke",function(t){return e(t.index)}).attr("d",d3.svg.arc().innerRadius(innerRadius).outerRadius(outerRadius)).on("mouseover",function(i,e){t(.1)(i,e)}).on("mouseout",t(1)).on("click",function(t){info.html(districts[t.index].name)}),svg.append("g").attr("class","chord").selectAll("path").data(i.chords).enter().append("path").attr("d",d3.svg.chord().radius(innerRadius)).style("fill",function(t){return e(t.target.index)}).style("opacity",1).on("click",function(t){var i=districts[t.source.index].relationships[t.target.index],e="<h3>"+districts[t.source.index].name+" to "+districts[t.target.index].name+"</h3>";$.each(i,function(t,i){var r=rows[i];e+=r.when+" - "+r.specificwhat+"<br/>"}),info.html(e)})};$(function(){Tabletop.init({key:"1XkV1ePpq5piIfonZWShm7SZd78lqKvvgSP_u2hl54ic",callback:function(t){initGraph(),createMap(t)},simpleSheet:!0,debug:!0})});