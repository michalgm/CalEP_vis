var svg,info,tooltip,chord,height,width,labelSize,districts=[],matrix=[],districtIndex={},rows=[],displayType="districts",maxLabel="",debugMode=!1,addDistrict=function(t){if(t){if(t=$.trim(t),"districts"==displayType&&("Expert"==t||"Neutral - CEP"==t||"Neutral - WestEd"==t))return;t.length>maxLabel.length&&(maxLabel=t),districtIndex[t]||(districtIndex[t]=1)}},getGets=function(t){var e=[];t.get&&e.push(t.get);for(var i=2;t["get_"+i];)e.push(t["get_"+i]),i++;return e},createMap=function(){$.each(rows,function(t,e){addDistrict(e.give),$.map(getGets(e),addDistrict)}),labelTest=svg.append("text").attr("id","maxLabel").text(maxLabel),labelSize=$("#maxLabel")[0].getBBox().width,labelTest.remove();var t=0;$.each(districtIndex,function(e){districtIndex[e]=t,matrix[t]=[];for(var i=0;i<Object.keys(districtIndex).length;i++)matrix[t].push(0);districts[t]={index:t,name:e,relationships:{},gives:0,gets:0},t++});var e=function(t,e,i,n,r){if(t!=e){var a=0,s=1;n&&(s=1/n),matrix[t][e]+=s+a,matrix[e][t]+="both"==displayType?s+a:a;var o=function(t,e,n){var r={id:i,type:n};void 0===districts[t].relationships[e]?districts[t].relationships[e]=[r]:districts[t].relationships[e].push(r)};r?o(t,e,"mutual"):(o(t,e,"give"),o(e,t,"get")),districts[t].gives+=s,districts[e].gets+=s}};$.each(rows,function(t,i){var n=getGets(i);if(i.give&&void 0!==districtIndex[i.give]){var r=districtIndex[i.give],a=districtIndex[i.get];"get"==displayType&&(a=districtIndex[i.give]),$.each(n,function(i,s){"get"==displayType?r=districtIndex[s]:a=districtIndex[s],e(r,a,t,n.length)})}else $.each(n,function(i,s){$.each(n,function(i,o){r=districtIndex[s],a=districtIndex[o],"get"==displayType&&(r=districtIndex[o],a=districtIndex[s]),e(r,a,t,n.length-1,!0)})})}),drawGraph()},startAngle=function(t){return chord.groups()[t].startAngle},endAngle=function(t){return chord.groups()[t].endAngle},resize=function(){var t=$("#viz-container").width(),e=$("#content").height();graphSize=Math.min(t,e),$("#viz-container svg").attr("width",graphSize).attr("height",graphSize),svg.attr("transform","translate("+graphSize/2+","+graphSize/2+")");var i=.41*graphSize-labelSize,n=1.1*i;svg.selectAll(".chord-group").data(chord.groups).attr("d",d3.svg.arc().innerRadius(i).outerRadius(n)),svg.selectAll(".chord").data(chord.chords).attr("d",d3.svg.chord().radius(i)),svg.selectAll(".labels text").data(chord.groups).attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+(n+10)+")"+(t.angle>Math.PI?"rotate(180)":"")})},initGraph=function(){$(".loading").hide(),$("#controls").show();var t=$("#viz-container").width(),e=$("#content").height();graphSize=Math.min(t,e),svg=d3.select("#viz-container").append("svg").attr("id","chordGraph").attr("width",graphSize).attr("height",graphSize).append("g").attr("transform","translate("+graphSize/2+","+graphSize/2+")").on("mousemove",function(){"none"!=tooltip.style("display")&&moveTooltip()}).on("mouseout",hideTooltip),info=d3.select("#info"),$("#controls input").on("change",redrawGraph),$(window).on("resize",resize),tooltip=d3.select("#content").append("div").attr("id","tooltip")},redrawGraph=function(){displayType=$("input:radio[name=display-type]:checked").val(),matrix=[],maxLabel="",districtIndex={},districts=[],svg.selectAll("*").remove(),createMap(),$("#info").hide()},moveTooltip=function(){tooltip.style("top",d3.event.pageY+5+"px"),tooltip.style("left",d3.event.pageX+5+"px")},showTooltip=function(t){moveTooltip(),tooltip.style("display","block"),tooltip.html(t)},hideTooltip=function(){tooltip.style("display","none")},showInfo=function(t,e){$("#info .panel-title").html(""),$("#info .list-group").html(""),$("#info").show(),$("#info .nav-tabs>li").show(),$("#info .nav-tabs li:first a").html(t),$("#info .nav-tabs li:nth-child(2) a").html(e)},showRow=function(t,e){var i=rows[t],n=i.when+" - "+i.specificwhat;"Expert"==i.give&&(n+=" (Expert)"),void 0===districtIndex[i.give]&&(n+=" (Mutual)");var r="";r+=i._orig_give?"<div>Host: "+i._orig_give+"</div>":"",r+="Participants: "+getGets(i).join(", ");var a=i.survey&&i.survey.match(/^http/i)?" <a class='btn btn-default btn-sm' target='_blank' href='"+i.survey+"'> Survey</a>":"",s=i.onlinespace&&i.onlinespace.match(/^http/i)?" <a class='btn btn-default btn-sm' target='_blank' href='"+i.onlinespace+"'> Online Space</a>":"",o=a+s;$("#info #"+e+"s .list-group").append("<li class='row-info list-group-item'><span class='pull-right btn-group'>"+o+"</span><h4 class='list-group-item-heading'>"+n+"</h4><div class='list-group-item-text'>"+r+"</div></li>")},drawGraph=function(){var t=.41*graphSize-labelSize,e=1.1*t,i=function(t){return function(e,i){svg.selectAll(".chords path").filter(function(t){return e.source?t.source.index!==e.source.index||t.target.index!==e.target.index:t.source.index!==i&&t.target.index!==i}).transition().style("opacity",t)}};chord=d3.layout.chord().padding(.02).sortChords(d3.descending).sortGroups(d3.descending).sortSubgroups(d3.descending).matrix(matrix);var n=d3.scale.category20();svg.append("g").attr("class","chord-groups").selectAll("path").data(chord.groups).enter().append("path").attr("class","chord-group").style("fill",function(t){return n(t.index)}).style("stroke",function(t){return n(t.index)}).attr("d",d3.svg.arc().innerRadius(t).outerRadius(e)).on("click",function(t){showInfo("Gives","Gets");var e=districts[t.index],i=e.name;$("#info .panel-title").html(i);var n={};$.each(e.relationships,function(t,e){$.each(e,function(t,e){n[e.id]=e.type})}),$.each(n,function(e,i){showRow(e,i,t.index)}),$(".tab-content .list-group:empty").html('<li class="list-group-item"><div class="list-group-item-text">No experiences</div></li>'),$("#info .nav-tabs li:first a").tab("show")}).on("mouseover",function(t,e){i(.1)(t,e)}).on("mouseout",i(1)),svg.append("g").attr("class","chords").selectAll("path").data(chord.chords).enter().append("path").attr("class","chord").attr("d",d3.svg.chord().radius(t)).style("fill",function(t){return n(t.source.index)}).style("opacity",1).on("click",function(t){showInfo(districts[t.source.index].name,districts[t.target.index].name);var e=districts[t.source.index].relationships[t.target.index],i=districts[t.source.index].name+" to / from "+districts[t.target.index].name;$("#info .panel-title").html(i),$.each(e,function(t,e){showRow(e.id,e.type)}),$(".tab-content .list-group:empty").html('<li class="list-group-item"><div class="list-group-item-text">No experiences</div></li>'),$("#info .nav-tabs li:first a").tab("show")}).on("mouseover",function(t,e){var n=t.source.index,r=t.target.index;"get"==displayType&&(n=t.target.index,r=t.source.index);var a=districts[n].name+" to / from "+districts[r].name;showTooltip(a),i(.1)(t,e)}).on("mouseout",i(1)),svg.append("g").attr("class","labels").selectAll("text").data(chord.groups).enter().append("text").each(function(t,e){t.angle=(startAngle(e)+endAngle(e))/2}).attr("dy",".35em").attr("text-anchor",function(t){return t.angle>Math.PI?"end":null}).attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+(e+10)+")"+(t.angle>Math.PI?"rotate(180)":"")}).text(function(t,e){return districts[e].name})},roundToTwo=function(t){return+(Math.round(t+"e+2")+"e-2")};$(function(){var t,e=function(){t=Tabletop.init({key:"1XkV1ePpq5piIfonZWShm7SZd78lqKvvgSP_u2hl54ic",callback:function(t){rows[0]||(initGraph(),$.each(t,function(t,e){e._orig_give=e.give,"Expert"==$.trim(e.strand)&&(e.give="Expert")}),rows=t,createMap())},simpleSheet:!0,debug:!0})},i=function(){rows[0]||(e(),setTimeout(i,3500))};i()});