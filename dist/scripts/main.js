var districts=[],matrix=[],districtIndex={},rows=[],svg,info,tooltip,width=750,height=750,chord,addDistrict=function(t){t&&(districtIndex[t]||(districtIndex[t]=1))},createMap=function(t){var i=$("input:radio[name=display-type]:checked").val();rows=t,$.each(t,function(t,i){addDistrict(i.give),addDistrict(i.get);for(var e=2;i["get_"+e];)addDistrict(i["get_"+e]),e++});var e=0;$.each(districtIndex,function(t){for(districtIndex[t]=e,matrix[e]=[],c=0;c<Object.keys(districtIndex).length;c++)matrix[e].push(0);districts[e]={index:e,name:t,relationships:[]},e++});var r=function(t,e,r,o){"give"==i?e=districtIndex[o]:t=districtIndex[o];var a=.1;matrix[t][e]+=1+a,matrix[e][t]="both"==i?matrix[t][e]:a,void 0===districts[t].relationships[e]?districts[t].relationships[e]=[r]:districts[t].relationships[e].push(r)};$.each(t,function(t,e){if(e.give){var o,a;"give"==i?o=districtIndex[e.give]:a=districtIndex[e.give],e.get&&r(o,a,t,e.get);for(var n=2;e["get_"+n];)r(o,a,t,e["get_"+n]),n++}}),drawGraph()},resize=function(){var t=$("#viz-container").width(),i=$("#content").height();graphSize=Math.min(t,i),$("#viz-container svg").attr("width",graphSize).attr("height",graphSize),svg.attr("transform","translate("+graphSize/2+","+graphSize/2+")");var e=.41*graphSize,r=1.1*e;svg.selectAll(".chord-group").data(chord.groups).attr("d",d3.svg.arc().innerRadius(e).outerRadius(r)),svg.selectAll(".chord").data(chord.chords).attr("d",d3.svg.chord().radius(e))},initGraph=function(){$(".loading").hide(),$("#controls").show();var t=$("#viz-container").width(),i=$("#content").height();graphSize=Math.min(t,i),svg=d3.select("#viz-container").append("svg").attr("id","chordGraph").attr("width",graphSize).attr("height",graphSize).append("g").attr("transform","translate("+graphSize/2+","+graphSize/2+")").on("mousemove",function(){"none"!=tooltip.style("display")&&moveTooltip()}).on("mouseout",hideTooltip),info=d3.select("#info"),$("#controls input").on("change",redrawGraph),$(window).on("resize",resize),tooltip=d3.select("#content").append("div").attr("id","tooltip")},redrawGraph=function(){matrix=[],districtIndex={},districts=[],svg.selectAll("*").remove(),createMap(rows)},moveTooltip=function(){tooltip.style("top",d3.event.pageY+5+"px"),tooltip.style("left",d3.event.pageX+5+"px")},showTooltip=function(t){moveTooltip(),tooltip.style("display","block"),tooltip.html(t)},hideTooltip=function(){tooltip.style("display","none")},drawGraph=function(){var t=.41*graphSize,i=1.1*t,e=function(t){return function(i,e){svg.selectAll(".chord path").filter(function(t){return t.source.index!==e&&t.target.index!==e}).transition().style("opacity",t)}};chord=d3.layout.chord().padding(.02).sortSubgroups(d3.descending).matrix(matrix);var r=d3.scale.category20();svg.append("g").attr("class","chord-groups").selectAll("path").data(chord.groups).enter().append("path").attr("class","chord-group").style("fill",function(t){return r(t.index)}).style("stroke",function(t){return r(t.index)}).attr("d",d3.svg.arc().innerRadius(t).outerRadius(i)).on("mouseover",function(t,i){showTooltip(districts[t.index].name),e(.1)(t,i)}).on("mouseout",e(1)),svg.append("g").attr("class","chords").selectAll("path").data(chord.chords).enter().append("path").attr("class","chord").attr("d",d3.svg.chord().radius(t)).style("fill",function(t){return r(t.target.index)}).style("opacity",1).on("click",function(t){var i=districts[t.source.index].relationships[t.target.index],e="<h4>"+districts[t.source.index].name+" to "+districts[t.target.index].name+"</h4>";$.each(i,function(t,i){var r=rows[i];e+=r.when+" - "+r.specificwhat+"<br/>"}),info.html(e)})};$(function(){Tabletop.init({key:"1XkV1ePpq5piIfonZWShm7SZd78lqKvvgSP_u2hl54ic",callback:function(t){initGraph(),createMap(t)},simpleSheet:!0,debug:!0})});