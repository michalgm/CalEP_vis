var districts=[],matrix=[],districtIndex={},rows=[],svg,info,tooltip,width=750,height=750,innerRadius=.41*Math.min(width,height),outerRadius=1.1*innerRadius,addDistrict=function(t){t&&(districtIndex[t]||(districtIndex[t]=1))},createMap=function(t){var i=$("input:radio[name=display-type]:checked").val();rows=t,$.each(t,function(t,i){addDistrict(i.give),addDistrict(i.get);for(var e=2;i["get_"+e];)addDistrict(i["get_"+e]),e++});var e=0;$.each(districtIndex,function(t){for(districtIndex[t]=e,matrix[e]=[],c=0;c<Object.keys(districtIndex).length;c++)matrix[e].push(0);districts[e]={index:e,name:t,relationships:[]},e++});var n=function(t,e,n,o){"give"==i?e=districtIndex[o]:t=districtIndex[o],matrix[t][e]++,"both"==i&&matrix[e][t]++,void 0===districts[t].relationships[e]?districts[t].relationships[e]=[n]:districts[t].relationships[e].push(n)};$.each(t,function(t,e){if(e.give){var o,r;"give"==i?o=districtIndex[e.give]:r=districtIndex[e.give],e.get&&n(o,r,t,e.get);for(var s=2;e["get_"+s];)n(o,r,t,e["get_"+s]),s++}}),console.log(JSON.stringify(matrix).replace(/],/g,"],\n")),drawGraph()},initGraph=function(){$(".loading").hide(),$("#controls").show(),svg=d3.select("#viz-container").append("svg").attr("id","chordGraph").attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height/2+")").on("mousemove",function(){"none"!=tooltip.style("display")&&moveTooltip()}).on("mouseout",hideTooltip),info=d3.select("#info"),$("#controls input").on("change",redrawGraph),tooltip=d3.select("#content").append("div").attr("id","tooltip")},redrawGraph=function(){matrix=[],districtIndex={},districts=[],svg.selectAll("*").remove(),createMap(rows)},moveTooltip=function(){tooltip.style("top",d3.event.y+5+"px"),tooltip.style("left",d3.event.x+5+"px")},showTooltip=function(t){moveTooltip(),tooltip.style("display","block"),tooltip.html(t)},hideTooltip=function(){tooltip.style("display","none")},drawGraph=function(){var t=function(t){return function(i,e){svg.selectAll(".chord path").filter(function(t){return t.source.index!==e&&t.target.index!==e}).transition().style("opacity",t)}},i=d3.layout.chord().padding(.02).sortSubgroups(d3.descending).matrix(matrix),e=d3.scale.category20();svg.append("g").selectAll("path").data(i.groups).enter().append("path").style("fill",function(t){return e(t.index)}).style("stroke",function(t){return e(t.index)}).attr("d",d3.svg.arc().innerRadius(innerRadius).outerRadius(outerRadius)).on("mouseover",function(i,e){showTooltip(districts[i.index].name),t(.1)(i,e)}).on("mouseout",t(1)),svg.append("g").attr("class","chord").selectAll("path").data(i.chords).enter().append("path").attr("d",d3.svg.chord().radius(innerRadius)).style("fill",function(t){return e(t.target.index)}).style("opacity",1).on("click",function(t){var i=districts[t.source.index].relationships[t.target.index],e="<h4>"+districts[t.source.index].name+" to "+districts[t.target.index].name+"</h4>";$.each(i,function(t,i){var n=rows[i];e+=n.when+" - "+n.specificwhat+"<br/>"}),info.html(e)})};$(function(){Tabletop.init({key:"1XkV1ePpq5piIfonZWShm7SZd78lqKvvgSP_u2hl54ic",callback:function(t){initGraph(),createMap(t)},simpleSheet:!0,debug:!0})});