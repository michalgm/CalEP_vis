"use strict";var svg,info,tooltip,chord,labelSize,districts={},matrix=[],districtIndex={},rows=[],displayType="normalized",maxLabel="",colors=["rgb(166,206,227)","rgb(31,120,180)","rgb(178,223,138)","rgb(51,160,44)","rgb(251,154,153)","rgb(227,26,28)","rgb(253,191,111)","rgb(255,127,0)","rgb(202,178,214)","rgb(106,61,154)"],nicetypes={give:"Hosted",get:"Attended",mutual:"Shared"},addDistrict=function(t){if(t){if("Expert"===t||"Neutral - CEP"===t||"Neutral - WestEd"===t)return;t.length>maxLabel.length&&(maxLabel=t),districtIndex[t]||(districtIndex[t]=1)}},getGets=function(t){var e=[];t.get&&e.push(t.get);for(var n=2;t["get_"+n];)e.push(t["get_"+n]),n++;return e},createMap=function(){$.each(rows,function(t,e){addDistrict(e.give),$.map(getGets(e),addDistrict)});var t=svg.append("text").attr("id","maxLabel").text(maxLabel);labelSize=$("#maxLabel")[0].getBBox().width,t.remove();var e=0;$.each(Object.keys(districtIndex).sort(),function(t,n){matrix=matrix.concat(e,e+1,e+2),districtIndex[n]={name:n,relationships:{give:{},get:{},mutual:{}},counts:{}},$.each(["give","get","mutual"],function(t,i){districtIndex[n][i]=e,districtIndex[n].counts[i]={count:0,participants:0,districts:{}},matrix[e]=[];for(var r=0;r<Object.keys(districtIndex).length;r++)matrix[e].push(0),matrix[e].push(0),matrix[e].push(0);districts[e]={index:e,name:n,type:i},e++})});var n=function(t,e,n,i,r){if(t!==e){var s=function(t,e,r){var s={id:n,type:r,count:i},a=districtIndex[districts[t].name],o=districtIndex[districts[e].name];void 0===a.relationships[r][o.name]?(a.relationships[r][o.name]=[s],a.counts[r].districts[o.name]={count:0,participants:0}):a.relationships[r][o.name].push(s)};r?(matrix[e][t]+=1/i,s(t,e,"mutual")):(matrix[e][t]++,matrix[t][e]+="normalized"===displayType?1/i:1,s(t,e,"give"),s(e,t,"get"))}};$.each(rows,function(t,e){var i=getGets(e);if(e.give&&"Cal. Ed. Partners"!==districtIndex[e.give]){var r=districtIndex[e.give].give;districtIndex[e.give].counts.give.count++,districtIndex[e.give].counts.give.participants+=i.length,$.each(i,function(s,a){var o=districtIndex[a].get;districtIndex[a].counts.get.count++,districtIndex[a].counts.get.participants+=i.length,n(r,o,t,i.length),districtIndex[e.give].counts.give.districts[a].count++,districtIndex[e.give].counts.give.districts[a].participants+=i.length})}else $.each(i,function(e,r){districtIndex[r].counts.mutual.count++,districtIndex[r].counts.mutual.participants+=i.length,$.each(i,function(e,s){var a=districtIndex[r].mutual,o=districtIndex[s].mutual;n(a,o,t,i.length,!0),a!==o&&(districtIndex[r].counts.mutual.districts[s].count++,districtIndex[r].counts.mutual.districts[s].participants+=i.length)})})}),drawGraph()},startAngle=function(t){return chord.groups()[t].startAngle},endAngle=function(t){return chord.groups()[t].endAngle},redrawGraph=function(){displayType=$("input:radio[name=display-type]:checked").val(),matrix=[],maxLabel="",districtIndex={},districts={},svg.selectAll("*").remove(),createMap(),$("#info").hide()},moveTooltip=function(){tooltip.style("top",d3.event.pageY+5+"px"),tooltip.style("left",d3.event.pageX+5+"px")},showTooltip=function(t){moveTooltip(),tooltip.style("display","block"),tooltip.html(t)},hideTooltip=function(){tooltip.style("display","none")},showInfo=function(t,e,n,i){$("#info .panel-title").html(t),$("#info .list-group").html(""),$.each(e,function(t,e){showRow(e.id,e.type)}),$("#info").css("display","flex"),$(".tab-content .list-group:empty").html('<li class="list-group-item"><div class="list-group-item-text">No experiences</div></li>'),$('#info .nav-tabs li a[href="#'+n+'s"]').tab("show"),$("#info .nav-tabs>li").toggle(!i)},showRow=function(t,e){var n=rows[t],i=n.when+" - "+n.specificwhat;"Expert"===n.give&&(i+=" (Expert)"),"Cal. Ed. Partners"===districtIndex[n.give]&&(i+=" (Mutual)");var r="";r+=n._origGive?"<div>Host: "+n._origGive+"</div>":"",r+="Participants: "+getGets(n).join(", ");var s=n.survey&&n.survey.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+n.survey+'"> Survey</a>':"",a=n.onlinespace&&n.onlinespace.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+n.onlinespace+'"> Online Space</a>':"",o=s+a;$("#info #"+e+"s .list-group").append('<li class="row-info list-group-item"><span class="pull-right btn-group">'+o+'</span><h4 class="list-group-item-heading">'+i+'</h4><div class="list-group-item-text">'+r+"</div></li>")},drawGraph=function(){var t=function(t){return districtIndex[districts[t.index].name]},e=function(t,e){return function(n,i){svg.selectAll(".chords path").filter(function(t){return e?districts[t.source.index].name!==districts[n.index].name&&districts[t.target.index].name!==districts[n.index].name:n.source?t.source.index!==n.source.index||t.target.index!==n.target.index:t.source.index!==i&&t.target.index!==i}).transition().style("opacity",t)}},n=function(t){var e=districts[t.index],n=colors[Object.keys(districtIndex).indexOf(e.name)];return n};chord=d3.layout.chord().padding(.02).sortChords(d3.descending).sortSubgroups(d3.descending).matrix(matrix),svg.append("g").attr("class","district-groups").selectAll("path").data(chord.groups().filter(function(t){return"give"===districts[t.index].type})).enter().append("path").attr("class","district-group").style("fill",function(t){return n(t)}).style("stroke",function(t){return n(t)}),svg.append("g").attr("class","chord-groups").selectAll("path").data(chord.groups).enter().append("path").attr("class","chord-group").style("fill",function(t){return n(t)}).style("stroke",function(t){return n(t)}).on("mouseover",function(n,i){var r=t(n),s=districts[n.index].type,a=nicetypes[s],o=r.counts[s].count,c=r.name+" "+a+" "+o+("mutual"===s?" Mutual":"")+" Experience"+(1===o?"":"s");showTooltip(c),e(.1)(n,i)}).on("mouseout",e(1)),svg.append("g").attr("class","chords").selectAll("path").data(chord.chords).enter().append("path").attr("class","chord").style("fill",function(t){var e=districts[t.source.index];return"get"===e.type?n(t.target):"mutual"===e.type?"#999":n(t.source)}).style("opacity",1).on("click",function(e){var n="give"===districts[e.source.index].type?"source":"target",i="give"===districts[e.source.index].type?"target":"source",r=e[n].index,s=t(e[n]),a=t(e[i]),o=districts[r].type,c="";c="mutual"===o?"Mutual between "+s.name+" and "+a.name:s.name+" to "+a.name,showInfo(c,s.relationships[o][a.name],o,!0)}).on("mouseover",function(n,i){var r="give"===districts[n.source.index].type?"source":"target",s="give"===districts[n.source.index].type?"target":"source",a=n[r].index,o=t(n[r]),c=t(n[s]),d="",u=o.counts[districts[a].type].districts[c.name];d="mutual"===districts[a].type?o.name+" and "+c.name:o.name+" to  "+c.name,d+="<br>"+u.count+("mutual"===districts[a].type?" Mutual":"")+" Experience"+(1===u.count?"":"s"),showTooltip(d),e(.1)(n,i)}).on("mouseout",e(1)),svg.append("g").attr("class","sublabels").selectAll("text").data(chord.groups).enter().append("text").attr("class","glyphicon sublabel").attr("pointer-events","none").each(function(t){t.angle=(startAngle(t.index)+endAngle(t.index))/2}).attr("dy",".4em").attr("fill",function(t){return d3.rgb(n(t)).darker(3)}),svg.append("g").attr("class","labels").selectAll("text").data(chord.groups().filter(function(t){return"give"===districts[t.index].type})).enter().append("text").attr("class","district-label").each(function(t){t.center=(t.startAngle+endAngle(t.index+2))/2}).attr("dy",".35em").attr("text-anchor",function(t){return t.center>Math.PI?"end":null}).text(function(t){return districts[t.index].name}),d3.selectAll(".district-label, .district-group").on("mouseover",function(n,i){var r=t(n),s=r.name+" - "+(r.counts.give.count+r.counts.get.count+r.counts.mutual.count)+" Experiences";showTooltip(s),e(.1,!0)(n,i)}).on("mouseout",e(1,!0)),d3.selectAll(".sublabel, .chord-group, .district-group, .district-label").on("click",function(e){var n=t(e),i={};$.each(n.relationships,function(t,e){$.each(e,function(e,n){$.each(n,function(e,n){i[n.id]={id:n.id,type:t}})})}),showInfo(n.name,i,districts[e.index].type)}),resize()},resize=function(){var t=$("#viz-container").width(),e=$("#content").height(),n=Math.min(t,e);$("#viz-container svg").attr("width",n).attr("height",n),svg.attr("transform","translate("+n/2+","+n/2+")");var i=.5*n-labelSize-10,r=.99*i,s=.98*r,a=.94*s,o=roundToTwo(.7*(s-a));svg.selectAll(".chord-group").attr("d",d3.svg.arc().innerRadius(a).outerRadius(s)),svg.selectAll(".district-group").attr("d",function(t){return d3.svg.arc().startAngle(startAngle(t.index)).endAngle(endAngle(t.index+2)).innerRadius(r).outerRadius(i)()}),svg.selectAll(".chord").attr("d",d3.svg.chord().radius(a)),svg.selectAll(".sublabel").attr("font-size",o+"px").attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+(a+roundToTwo(.15*(s-a)))+")"}).text(function(t){return(t.endAngle-t.startAngle)*a>o?"give"===districts[t.index].type?"":"get"===districts[t.index].type?"":"":void 0}),svg.selectAll(".district-label").attr("transform",function(t){return"rotate("+(180*t.center/Math.PI-90)+")translate("+(i+5)+")"+(t.center>Math.PI?"rotate(180)":"")})},initGraph=function(){$(".loading").hide(),$("#controls").css("display","flex"),svg=d3.select("#viz-container").append("svg").attr("id","chordGraph").append("g").on("mousemove",function(){"none"!==tooltip.style("display")&&moveTooltip()}).on("mouseout",hideTooltip),info=d3.select("#info"),$("#controls input").on("change",redrawGraph),$(window).on("resize",resize),tooltip=d3.select("#content").append("div").attr("id","tooltip")},roundToTwo=function(t){return+(Math.round(t+"e+2")+"e-2")};$(function(){var t,e=function(){t=Tabletop.init({key:"187AL-Ve6sOLP_-j58xk8ANHi1cZfheDzDSMInC4snOg",callback:function(t){if(!rows[0]){var e=Object.keys(t);$.each(e,function(t,e){$(".worksheets").append("<option>"+e+"</option>")});{$(".worksheets").find(":selected").text()}initGraph();var n={},i={};$.each(t["CALLI - 4-6 Language Development"].elements,function(t,e){i[e.surveyname]?"Attended"===e.hostattendmutual?n[e.surveyname][e.account]=!0:"Hosted"===e.hostattendmutual&&(i[e.surveyname].give=e.account,i[e.surveyname]._origGive=e.account):(i[e.surveyname]={},n[e.surveyname]={},i[e.surveyname].specificwhat=e.surveyname,i[e.surveyname].when=e.date,"Hosted"===e.hostattendmutual?(i[e.surveyname].give=e.account,i[e.surveyname]._origGive=e.account):"Attended"===e.hostattendmutual?n[e.surveyname][e.account]=!0:"Mutual"===e.hostattendmutual&&(i[e.surveyname].give="Cal. Ed. Partners"),i[e.surveyname].essentialQuestions=e.essentialquestions)}),$.each(n,function(t,e){var n="get",r=0;$.each(e,function(e){r>0&&(n="get_"+r),i[t][n]=e,r++})});var r=1;$.each(i,function(t,e){e.rowNumbers=r,rows.push(e),r++}),$.each(rows,function(t,e){e.give=$.trim(e.give),e.get=$.trim(e.get);for(var n=1;e["get_"+n];)e["get_"+n]=$.trim(e["get_"+n]),n++}),createMap()}},debug:!0})},n=function(){rows[0]||e()};n()});