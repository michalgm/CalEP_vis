!function(){"use strict";var t,e={},n={},a="normalized",i={},r={},o={},s=[],c="",u={},l=[],d=[],p={},g={},f=["rgb(166,206,227)","rgb(31,120,180)","rgb(178,223,138)","rgb(51,160,44)","rgb(251,154,153)","rgb(227,26,28)","rgb(253,191,111)","rgb(255,127,0)","rgb(202,178,214)","rgb(106,61,154)"],h={give:"Hosted",get:"Attended",mutual:"Mutual"},v=function(t){if(t){if("Expert"===t||"Neutral - CEP"===t||"Neutral - WestEd"===t)return;t.length>c.length&&(c=t),r[t]||(r[t]=1)}},m=function(t){var e=[];t.get&&e.push(t.get);for(var n=2;t["get_"+n];)e.push(t["get_"+n]),n++;return e},x=function(){$.each(l,function(t,e){v(e.give),$.map(m(e),v)});var e=p.append("text").attr("id","maxLabel").text(c);t=$("#maxLabel")[0].getBBox().width,e.remove();var n=0;$.each(Object.keys(r).sort(),function(t,e){s=s.concat(n,n+1,n+2),r[e]={name:e,relationships:{give:{},get:{},mutual:{}},counts:{}},$.each(["give","get","mutual"],function(t,a){r[e][a]=n,r[e].counts[a]={count:0,participants:0,districts:{}},s[n]=[];for(var o=0;o<Object.keys(r).length;o++)s[n].push(0),s[n].push(0),s[n].push(0);i[n]={index:n,name:e,type:a},n++})});var o=function(t,e,n,o,c){if(t!==e){var u=function(t,e,a){var s={id:n,type:a,count:o},c=r[i[t].name],u=r[i[e].name];void 0===c.relationships[a][u.name]?(c.relationships[a][u.name]=[s],c.counts[a].districts[u.name]={count:0,participants:0}):c.relationships[a][u.name].push(s)};c?(s[e][t]+=1/o,u(t,e,"mutual")):(s[e][t]++,s[t][e]+="normalized"===a?1/o:1,u(t,e,"give"),u(e,t,"get"))}};$.each(l,function(t,e){var n=m(e);if(e.give&&void 0!==r[e.give]){var a=r[e.give].give;r[e.give].counts.give.count++,r[e.give].counts.give.participants+=n.length,$.each(n,function(i,s){var c=r[s].get;r[s].counts.get.count++,r[s].counts.get.participants+=n.length,o(a,c,t,n.length),r[e.give].counts.give.districts[s].count++,r[e.give].counts.give.districts[s].participants+=n.length})}else $.each(n,function(e,a){r[a].counts.mutual.count++,r[a].counts.mutual.participants+=n.length,$.each(n,function(e,i){var s=r[a].mutual,c=r[i].mutual;o(s,c,t,n.length,!0),s!==c&&(r[a].counts.mutual.districts[i].count++,r[a].counts.mutual.districts[i].participants+=n.length)})})}),z()},b=function(t){return e.groups()[t].startAngle},y=function(t){return e.groups()[t].endAngle},A=function(){a=$("input:radio[name=display-type]:checked").val(),s=[],c="",r={},i={},p.selectAll("*").remove(),x(),$("#info").hide()},k=function(){g.style("top",d3.event.pageY+5+"px"),g.style("left",d3.event.pageX+5+"px")},E=function(t){k(),g.style("display","block"),g.html(t)},M=function(){g.style("display","none")},w=function(t,e,n,a){$("#info .panel-title").html(t),$("#info .list-group").html(""),$.each(e,function(t,e){_(e.id,e.type)}),$("#info").css("display","flex"),$(".tab-content .list-group:empty").html('<li class="list-group-item"><div class="list-group-item-text">No experiences</div></li>'),$('#info .nav-tabs li a[href="#'+n+'s"]').tab("show"),$("#info .nav-tabs>li").toggle(!a)},_=function(t,e){var n=l[t],a=n.when+" - "+n.specificwhat;"Expert"===n.give&&(a+=" (Expert)"),void 0===r[n.give]&&(a+=" (Mutual)");var i="";i+=n._origGive?"<div>Host: "+n._origGive+"</div>":"",i+="Participants: "+m(n).join(", ");var o=n.survey&&n.survey.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+n.survey+'"> Survey</a>':"",s=n.onlinespace&&n.onlinespace.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+n.onlinespace+'"> Online Space</a>':"",c=o+s;$("#info #"+e+"s .list-group").append('<li class="row-info list-group-item"><span class="pull-right btn-group">'+c+'</span><h4 class="list-group-item-heading">'+a+'</h4><div class="list-group-item-text">'+i+"</div></li>")},z=function(){var t=function(t){return r[i[t.index].name]},n=function(t,e){return function(n,a){p.selectAll(".chords path").filter(function(t){return e?i[t.source.index].name!==i[n.index].name&&i[t.target.index].name!==i[n.index].name:n.source?t.source.index!==n.source.index||t.target.index!==n.target.index:t.source.index!==a&&t.target.index!==a}).transition().style("opacity",t)}},a=function(t){var e=i[t.index],n=f[Object.keys(r).indexOf(e.name)];return n};e=d3.layout.chord().padding(.02).sortChords(d3.descending).sortSubgroups(d3.descending).matrix(s),p.append("g").attr("class","district-groups").selectAll("path").data(e.groups().filter(function(t){return"give"===i[t.index].type})).enter().append("path").attr("class","district-group").style("fill",function(t){return a(t)}).style("stroke",function(t){return a(t)}),p.append("g").attr("class","chord-groups").selectAll("path").data(e.groups).enter().append("path").attr("class","chord-group").style("fill",function(t){return a(t)}).style("stroke",function(t){return a(t)}).on("mouseover",function(e,a){var r=t(e),o=i[e.index].type,s=h[o],c=r.counts[o].count,u=r.name+" "+s+" "+c+("mutual"===o?" Mutual":"")+" Experience"+(1===c?"":"s");E(u),n(.1)(e,a)}).on("mouseout",n(1)),p.append("g").attr("class","chords").selectAll("path").data(e.chords).enter().append("path").attr("class","chord").style("fill",function(t){var e=i[t.source.index];return"get"===e.type?a(t.target):"mutual"===e.type?"#999":a(t.source)}).style("opacity",1).on("click",function(e){var n="give"===i[e.source.index].type?"source":"target",a="give"===i[e.source.index].type?"target":"source",r=e[n].index,o=t(e[n]),s=t(e[a]),c=i[r].type,u="";u="mutual"===c?"Mutual between "+o.name+" and "+s.name:o.name+" to "+s.name,w(u,o.relationships[c][s.name],c,!0)}).on("mouseover",function(e,a){var r="give"===i[e.source.index].type?"source":"target",o="give"===i[e.source.index].type?"target":"source",s=e[r].index,c=t(e[r]),u=t(e[o]),l="",d=c.counts[i[s].type].districts[u.name];l="mutual"===i[s].type?c.name+" and "+u.name:c.name+" to  "+u.name,l+="<br>"+d.count+("mutual"===i[s].type?" Mutual":"")+" Experience"+(1===d.count?"":"s"),E(l),n(.1)(e,a)}).on("mouseout",n(1)),p.append("g").attr("class","sublabels").selectAll("text").data(e.groups).enter().append("text").attr("class","glyphicon sublabel").attr("pointer-events","none").each(function(t){t.angle=(b(t.index)+y(t.index))/2}).attr("dy",".4em").attr("fill",function(t){return d3.rgb(a(t)).darker(3)}),p.append("g").attr("class","labels").selectAll("text").data(e.groups().filter(function(t){return"give"===i[t.index].type})).enter().append("text").attr("class","district-label").each(function(t){t.center=(t.startAngle+y(t.index+2))/2}).attr("dy",".35em").attr("text-anchor",function(t){return t.center>Math.PI?"end":null}).text(function(t){return i[t.index].name}),d3.selectAll(".district-label, .district-group").on("mouseover",function(e,a){var i=t(e),r=i.name+" - "+(i.counts.give.count+i.counts.get.count+i.counts.mutual.count)+" Experiences";E(r),n(.1,!0)(e,a)}).on("mouseout",n(1,!0)),d3.selectAll(".sublabel, .chord-group, .district-group, .district-label").on("click",function(e){var n=t(e),a={};$.each(n.relationships,function(t,e){$.each(e,function(e,n){$.each(n,function(e,n){a[n.id]={id:n.id,type:t}})})}),w(n.name,a,i[e.index].type)}),N()},N=function(){var e=$("#viz-container").width(),n=$("#content").height(),a=Math.min(e,n);$("#viz-container svg").attr("width",a).attr("height",a),p.attr("transform","translate("+a/2+","+a/2+")");var r=.5*a-t-10,o=.99*r,s=.98*o,c=.94*s,u=P(.7*(s-c));p.selectAll(".chord-group").attr("d",d3.svg.arc().innerRadius(c).outerRadius(s)),p.selectAll(".district-group").attr("d",function(t){return d3.svg.arc().startAngle(b(t.index)).endAngle(y(t.index+2)).innerRadius(o).outerRadius(r)()}),p.selectAll(".chord").attr("d",d3.svg.chord().radius(c)),p.selectAll(".sublabel").attr("font-size",u+"px").attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+(c+P(.15*(s-c)))+")"}).text(function(t){return(t.endAngle-t.startAngle)*c>u?"give"===i[t.index].type?"":"get"===i[t.index].type?"":"":void 0}),p.selectAll(".district-label").attr("transform",function(t){return"rotate("+(180*t.center/Math.PI-90)+")translate("+(r+5)+")"+(t.center>Math.PI?"rotate(180)":"")})},O=function(){$(".loading").hide(),$("#controls").css("display","flex"),p=d3.select("#viz-container").append("svg").attr("id","chordGraph").append("g").on("mousemove",function(){"none"!==g.style("display")&&k()}).on("mouseout",M),o=d3.select("#info"),$("#controls input").on("change",A),$(window).on("resize",N),g=d3.select("#content").append("div").attr("id","tooltip")},P=function(t){return+(Math.round(t+"e+2")+"e-2")};$(function(){var t,e=function(){t=Tabletop.init({key:"17zFXlLfqvhI05mtYcbvZ11aeCtM4HT1-DHJ2RwHdEZo",callback:function(t){l[0]||(d=Object.keys(t),console.log("sheetNames",d),console.log("docData[sheetNames[0]]",t[d[0]]),O(),t.sheetNames[0].elements.forEach(function(t){var e=t.idparticipant;u[e]||(u[e]={},u[t.idparticipant]={name:t.participantname,letterCode:t.participantlettercode,shortName:t.participantshortname}),n[t.idcollaboration]?n[t.idcollaboration].participants[e]=!0:(n[t.idcollaboration]={},n[t.idcollaboration]={name:t.tblcollaborationcollaborationname,participants:{}},n[t.idcollaboration].participants[e]=!0)}),$.each(t,function(t,e){e._origGive=e.give,e.give=$.trim(e.give),"Expert"===$.trim(e.strand)&&(e.give="Expert"),e.get=$.trim(e.get);for(var n=2;e["get_"+n];)e["get_"+n]=$.trim(e["get_"+n]),n++}),l=t,x())},debug:!0})},a=function(){l[0]||e()};a()})}();