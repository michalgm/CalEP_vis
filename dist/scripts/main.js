"use strict";var svg,info,tooltip,chord,labelSize,districts={},matrix=[],districtIndex={},rows=[],displayType="districts",maxLabel="",graphSize,debugMode=!1,colors=["rgb(166,206,227)","rgb(31,120,180)","rgb(178,223,138)","rgb(51,160,44)","rgb(251,154,153)","rgb(227,26,28)","rgb(253,191,111)","rgb(255,127,0)","rgb(202,178,214)","rgb(106,61,154)"],addDistrict=function(t){if(t){if(t=$.trim(t),"districts"===displayType&&("Expert"===t||"Neutral - CEP"===t||"Neutral - WestEd"===t))return;t.length>maxLabel.length&&(maxLabel=t),districtIndex[t]||(districtIndex[t]=1)}},getGets=function(t){var e=[];t.get&&e.push($.trim(t.get));for(var i=2;$.trim(t["get_"+i]);)e.push($.trim(t["get_"+i])),i++;return e},createMap=function(){$.each(rows,function(t,e){addDistrict(e.give),$.map(getGets(e),addDistrict)});var t=svg.append("text").attr("id","maxLabel").text(maxLabel);labelSize=$("#maxLabel")[0].getBBox().width,t.remove();var e=0;$.each(districtIndex,function(t){matrix=matrix.concat(e,e+1,e+2),districtIndex[t]={},$.each(["give","get","mutual"],function(i,r){districtIndex[t][r]=e,matrix[e]=[];for(var n=0;n<Object.keys(districtIndex).length;n++)matrix[e].push(0),matrix[e].push(0),matrix[e].push(0);districts[e]={index:e,name:t,type:r,relationships:{give:{},get:{},mutual:{}},gives:0,gets:0},e++})});var i=function(t,e,i,r,n){if(t!==e){var a=0,s=1;r&&(s=1/r),(!n||e>t)&&(matrix[t][e]+=s+a,matrix[e][t]+=s+a);var o=function(t,e,r){var n={id:i,type:r};void 0===districts[t].relationships[r][e]?districts[t].relationships[r][e]=[n]:districts[t].relationships[r][e].push(n)};n?o(t,e,"mutual"):(o(t,e,"give"),o(e,t,"get"))}};$.each(rows,function(t,e){var r=getGets(e);if(e.give&&void 0!==districtIndex[e.give]){var n=districtIndex[e.give].give,a=districtIndex[e.get].get;"get"===displayType&&(a=districtIndex[e.give].give),$.each(r,function(e,s){"get"===displayType?n=districtIndex[s].give:a=districtIndex[s].get,i(n,a,t,r.length)})}else $.each(r,function(e,s){$.each(r,function(e,o){n=districtIndex[s].mutual,a=districtIndex[o].mutual,"get"===displayType&&(n=districtIndex[o].mutual,a=districtIndex[s].mutual),i(n,a,t,r.length,!0)})})}),drawGraph()},startAngle=function(t){return chord.groups()[t].startAngle},endAngle=function(t){return chord.groups()[t].endAngle},resize=function(){var t=$("#viz-container").width(),e=$("#content").height();graphSize=Math.min(t,e),$("#viz-container svg").attr("width",graphSize).attr("height",graphSize),svg.attr("transform","translate("+graphSize/2+","+graphSize/2+")");var i=.5*graphSize-labelSize-10,r=.98*i,n=r-5,a=.95*n;svg.selectAll(".chord-group").data(chord.groups).attr("d",d3.svg.arc().innerRadius(a).outerRadius(n)),svg.selectAll(".district-group").data(chord.groups().filter(function(t){return"give"==districts[t.index].type})).attr("d",function(t){return d3.svg.arc().startAngle(startAngle(t.index)).endAngle(endAngle(t.index+2)).innerRadius(r).outerRadius(i)()}),svg.selectAll(".chord").data(chord.chords).attr("d",d3.svg.chord().radius(a)),svg.selectAll(".sublabels text").data(chord.groups).attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+(a+2)+")"}).text(function(t){return(t.endAngle-t.startAngle)*a>12?"give"==districts[t.index].type?"":"get"==districts[t.index].type?"":"":void 0}),svg.selectAll(".labels text").data(chord.groups().filter(function(t){return"give"==districts[t.index].type})).attr("transform",function(t){return"rotate("+(180*t.center/Math.PI-90)+")translate("+(i+5)+")"+(t.center>Math.PI?"rotate(180)":"")})},redrawGraph=function(){displayType=$("input:radio[name=display-type]:checked").val(),matrix=[],maxLabel="",districtIndex={},districts={},svg.selectAll("*").remove(),createMap(),$("#info").hide()},moveTooltip=function(){tooltip.style("top",d3.event.pageY+5+"px"),tooltip.style("left",d3.event.pageX+5+"px")},showTooltip=function(t){moveTooltip(),tooltip.style("display","block"),tooltip.html(t)},hideTooltip=function(){tooltip.style("display","none")},showInfo=function(t,e){$("#info .panel-title").html(""),$("#info .list-group").html(""),$("#info").show(),$("#info .nav-tabs>li").show(),$("#info .nav-tabs li:first a").html(t),$("#info .nav-tabs li:nth-child(2) a").html(e)},showRow=function(t,e){var i=rows[t],r=i.when+" - "+i.specificwhat;"Expert"===i.give&&(r+=" (Expert)"),void 0===districtIndex[i.give]&&(r+=" (Mutual)");var n="";n+=i._origGive?"<div>Host: "+i._origGive+"</div>":"",n+="Participants: "+getGets(i).join(", ");var a=i.survey&&i.survey.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+i.survey+'"> Survey</a>':"",s=i.onlinespace&&i.onlinespace.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+i.onlinespace+'"> Online Space</a>':"",o=a+s;$("#info #"+e+"s .list-group").append('<li class="row-info list-group-item"><span class="pull-right btn-group">'+o+'</span><h4 class="list-group-item-heading">'+r+'</h4><div class="list-group-item-text">'+n+"</div></li>")},drawGraph=function(){var t=.5*graphSize-labelSize-10,e=.98*t,i=e-5,r=.95*i,n=function(t){return function(e,i){svg.selectAll(".chords path").filter(function(t){return e.source?t.source.index!==e.source.index||t.target.index!==e.target.index:t.source.index!==i&&t.target.index!==i}).transition().style("opacity",t)}};chord=d3.layout.chord().padding(.02).sortChords(d3.descending).sortSubgroups(d3.descending).matrix(matrix);var a=function(t){return colors[Object.keys(districtIndex).indexOf(districts[t].name)]};svg.append("g").attr("class","district-groups").selectAll("path").data(chord.groups().filter(function(t){return"give"==districts[t.index].type})).enter().append("path").attr("class","district-group").style("fill",function(t){return a(t.index)}).style("stroke",function(t){return a(t.index)}).attr("d",function(i){return d3.svg.arc().startAngle(startAngle(i.index)).endAngle(endAngle(i.index+2)).innerRadius(e).outerRadius(t)()}).on("mouseover",function(t,e){var i=districts[e].name+" -  XX Experiences";showTooltip(i)}),svg.append("g").attr("class","chord-groups").selectAll("path").data(chord.groups).enter().append("path").attr("class","chord-group").style("fill",function(t){return a(t.index)}).style("stroke",function(t){return a(t.index)}).attr("d",d3.svg.arc().innerRadius(r).outerRadius(i)).on("click",function(t){showInfo("Gives","Gets");var e=districts[t.index],i=e.name;$("#info .panel-title").html(i);var r={};$.each(e.relationships,function(t,e){$.each(e,function(t,e){$.each(e,function(t,e){r[e.id+"type"]=e.type})})}),$.each(r,function(e,i){showRow(e,i,t.index)}),$(".tab-content .list-group:empty").html('<li class="list-group-item"><div class="list-group-item-text">No experiences</div></li>'),$("#info .nav-tabs li:first a").tab("show")}).on("mouseover",function(t,e){var i=districts[e].name+" "+districts[e].type+"s<br/>XX Experiences with YY participants";showTooltip(i),n(.1)(t,e)}).on("mouseout",n(1)),svg.append("g").attr("class","chords").selectAll("path").data(chord.chords).enter().append("path").attr("class","chord").attr("d",d3.svg.chord().radius(r)).style("fill",function(t){var e=districts[t.source.index];return"get"===e.type?a(t.target.index):"mutual"===e.type?"#999":a(t.source.index)}).style("opacity",1).on("mouseover",function(t,e){var i=t.source.index,r=t.target.index;("get"===displayType||"get"==districts[t.source.index].type)&&(i=t.target.index,r=t.source.index);var a=districts[i].name+" to  "+districts[r].name+"<br>XX Experiences with YY Total Participants";"mutual"==districts[t.source.index].type&&(a="Mutual experiences between "+districts[i].name+" and "+districts[r].name+"<br>XX Experiences with YY Total Participants"),showTooltip(a),n(.1)(t,e)}).on("mouseout",n(1)),svg.append("g").attr("class","sublabels").selectAll("text").data(chord.groups).enter().append("text").attr("class","glyphicon").each(function(t){t.angle=(startAngle(t.index)+endAngle(t.index))/2}).attr("dy",".35em").attr("font-size",".8em").attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+(r+2)+")"}).text(function(t){return(t.endAngle-t.startAngle)*r>14?"give"==districts[t.index].type?"":"get"==districts[t.index].type?"":"":void 0}).on("mouseover",function(t,e){var i=districts[e].name+" "+districts[e].type+"s<br/>XX Experiences with YY participants";showTooltip(i),n(.1)(t,e)}),svg.append("g").attr("class","labels").selectAll("text").data(chord.groups().filter(function(t){return"give"==districts[t.index].type})).enter().append("text").each(function(t){t.center=(t.startAngle+endAngle(t.index+2))/2}).attr("dy",".35em").attr("text-anchor",function(t){return t.center>Math.PI?"end":null}).attr("transform",function(e){return"rotate("+(180*e.center/Math.PI-90)+")translate("+(t+5)+")"+(e.center>Math.PI?"rotate(180)":"")}).text(function(t){return districts[t.index].name})},initGraph=function(){$(".loading").hide(),$("#controls").show();var t=$("#viz-container").width(),e=$("#content").height();graphSize=Math.min(t,e),svg=d3.select("#viz-container").append("svg").attr("id","chordGraph").attr("width",graphSize).attr("height",graphSize).append("g").attr("transform","translate("+graphSize/2+","+graphSize/2+")").on("mousemove",function(){"none"!==tooltip.style("display")&&moveTooltip()}).on("mouseout",hideTooltip),info=d3.select("#info"),$("#controls input").on("change",redrawGraph),$(window).on("resize",resize),tooltip=d3.select("#content").append("div").attr("id","tooltip")},roundToTwo=function(t){return+(Math.round(t+"e+2")+"e-2")};$(function(){var t,e=function(){t=Tabletop.init({key:"1XkV1ePpq5piIfonZWShm7SZd78lqKvvgSP_u2hl54ic",callback:function(t){rows[0]||(initGraph(),$.each(t,function(t,e){e._origGive=e.give,"Expert"===$.trim(e.strand)&&(e.give="Expert")}),rows=t,createMap())},simpleSheet:!0,debug:!0})},i=function(){rows[0]||(e(),setTimeout(i,3500))};i()});